#!/usr/bin/env ruby

require 'main'

# Explicitly require yaml because ruby 1.9.2 (and greater?) define YAML which
# causes main to not require it.
require 'yaml'

require 'cloudapp/drop_service'
require 'ostruct'

Main do
  def identity
    OpenStruct.new email:    config[:email], password: config[:password]
  end

  def service
    CloudApp::DropService.as_identity(identity).tap do |service|
      service.logger.level = Logger::WARN
    end
  end

  config email: 'arthur@dent.com', password: 'towel'

  mode :new do

    # Bookmark a link: `cloudapp new bookmark http://getcloudapp.com`
    mode :bookmark do
      argument('url') { cast :uri }

      def run
        response = service.create url: params[:url].value
        puts response.fetch 'url'
      end
    end

    # Share a file: `cloudapp new file screenshot.png`
    mode :file do
      argument('file') { cast :pathname }

      def run
        response = service.create path: params[:file].value
        puts response.fetch 'url'
      end
    end
  end

  # List newest drops: `cloudapp list [--count=5]`
  mode :list do
    option 'count', 'n' do
      argument :optional
      cast :integer
      default 20
    end

    def run
      response = service.drops(params[:count].value).map do |drop|
        "#{ drop['name'] } - #{ drop['url'] }"
      end

      puts response
    end
  end

end
